apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: minio-tenant-sync
spec:
  refreshInterval: '5m'
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    creationPolicy: Owner
    name: kjdev-core-env-configuration
    template:
      engineVersion: v2
      data:
        config.env: |
          export MINIO_BROWSER="on"

          export MINIO_ROOT_USER="{{ .RootUser }}"

          #
          # LDAP
          #

          export MINIO_IDENTITY_LDAP_SERVER_ADDR="ldap.mylogin.space:636"
          export MINIO_IDENTITY_LDAP_LOOKUP_BIND_DN="cn={{ .MinioUser }},ou=users,dc=mylogin,dc=space"
          export MINIO_IDENTITY_LDAP_LOOKUP_BIND_PASSWORD="{{ .MinioPassword }}"
          export MINIO_IDENTITY_LDAP_USER_DN_SEARCH_BASE_DN="ou=users,dc=mylogin,dc=space"
          export MINIO_IDENTITY_LDAP_USER_DN_SEARCH_FILTER="(objectClass=*)"
          export MINIO_IDENTITY_LDAP_GROUP_SEARCH_FILTER="(&(objectClass=group)(memberUid=%d))"

          # LDAP Groups
          export MINIO_IDENTITY_LDAP_GROUP_SEARCH_BASE_DN="ou=groups,dc=ldap,dc=mylogin,dc=space"
          export MINIO_IDENTITY_LDAP_USERNAME_FORMAT="cn=%s,ou=users,dc=ldap,dc=mylogin,dc=space"

          export MINIO_IDENTITY_OPENID_CONFIG_URL="https://idp.mylogin.space/application/o/S3/.well-known/openid-configuration"

          export MINIO_IDENTITY_OPENID_CLIENT_SECRET="{{ .OpenIDClientSecret }}"

          export MINIO_IDENTITY_OPENID_SCOPES="openid,profile,email,minio"

          export MINIO_ROOT_PASSWORD="{{ .RootPassword }}"

          export MINIO_STORAGE_CLASS_STANDARD="EC:2"

          export MINIO_IDENTITY_OPENID_CLIENT_ID="{{ .OpenIDClientID }}"

          export MINIO_IDENTITY_OPENID_REDIRECT_URI="https://s3.int.mylogin.space/oauth_callback"
  data:
    - secretKey: OpenIDClientID
      remoteRef:
        key: MinioOperator
        property: OpenIDClientID

    - secretKey: OpenIDClientSecret
      remoteRef:
        key: MinioOperator
        property: OpenIDClientSecret

    # Root
  
    - secretKey: RootUser
      remoteRef:
        key: MinioOperator
        property: RootUser

    - secretKey: RootPassword
      remoteRef:
        key: MinioOperator
        property: RootPassword


    - secretKey: MinioUser
      remoteRef:
        key: MinioOperator
        property: MinioUser

    - secretKey: MinioPassword
      remoteRef:
        key: MinioOperator
        property: MinioPassword
