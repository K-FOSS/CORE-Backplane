apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: s3-route
  namespace: kuadrant-core-prod
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    namespace: kuadrant-core-prod
    name: main-gw

  type: JSONPatch
  jsonPatches:
    - name: kuadrant-core-prod/main-gw/https
      type: type.googleapis.com/envoy.config.route.v3.RouteConfiguration
      operation:
        op: add
        path: /virtual_hosts/0
        value:
          domains:
            - s3.int.mylogin.space
          name: s3-route
          routes:
            - match:
                prefix: /outpost.goauthentik.io
              name: staticmain
              route:
                cluster: httproute/kube-system/authentik/rule/0

            - match:
                prefix: /
              metadata:
                filter_metadata:
                  envoy.filters.http.lua:
                    mykey_flow1: true
              name: s3-route
              route:
                cluster: httproute/core-prod/s3-route/rule/0
      

