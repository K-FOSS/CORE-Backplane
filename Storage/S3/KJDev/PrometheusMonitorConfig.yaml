- job_name: kjdev-core-minio-job
  bearer_token: ''
  metrics_path: /minio/v2/metrics/cluster
  scheme: https
  scrape_interval: 5m
  scrape_timeout: 30s
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  static_configs:
  - targets:
    - minio.core-prod.svc.cluster.local:443

apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: minio-prometheus-sync
  namespace: 
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    creationPolicy: Owner
    name: kjdev-core-env-configuration
    template:
      engineVersion: v2
      data:
        config.env: |
          export MINIO_BROWSER="on"

          export MINIO_ROOT_USER="{{ .RootUser }}"

          export MINIO_IDENTITY_OPENID_CONFIG_URL="https://idp.mylogin.space/application/o/S3/.well-known/openid-configuration"

          export MINIO_IDENTITY_OPENID_CLIENT_SECRET="{{ .OpenIDClientSecret }}"

          export MINIO_IDENTITY_OPENID_SCOPES="openid,profile,email,minio"

          export MINIO_ROOT_PASSWORD="{{ .RootPassword }}"

          export MINIO_STORAGE_CLASS_STANDARD="EC:2"

          export MINIO_IDENTITY_OPENID_CLIENT_ID="{{ .OpenIDClientID }}"

          export MINIO_IDENTITY_OPENID_REDIRECT_URI="https://s3.int.mylogin.space/oauth_callback"
  data:
    - secretKey: OpenIDClientID
      remoteRef:
        key: MinioOperator
        property: OpenIDClientID

    - secretKey: OpenIDClientSecret
      remoteRef:
        key: MinioOperator
        property: OpenIDClientSecret

    # Root
  
    - secretKey: RootUser
      remoteRef:
        key: MinioOperator
        property: RootUser

    - secretKey: RootPassword
      remoteRef:
        key: MinioOperator
        property: RootPassword


    - secretKey: MinioUser
      remoteRef:
        key: MinioOperator
        property: MinioUser

    - secretKey: MinioPassword
      remoteRef:
        key: MinioOperator
        property: MinioPassword
