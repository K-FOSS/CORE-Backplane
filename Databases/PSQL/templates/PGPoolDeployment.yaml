apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgpool

  labels:
    app.kubernetes.io/name: pgpool
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: pgpool

  template:
    metadata:
      labels:
        app.kubernetes.io/name: pgpool
    spec:
      containers:
      - name: pgpool
        image: pgpool/pgpool
        ports:
          - name: psql
            containerPort: 9999

        env:
          - name: PGPOOL_BACKEND_NODES
            value: |
              0:psql-main-0.psql-main.core-prod.svc.cluster.local:5432,1:psql-main-0.psql-main.core-prod.svc.cluster.local:5432
          
          - name: PGPOOL_SR_CHECK_USER
            valueFrom:
              secretKeyRef:
                name: repmgr.psql-main.credentials.postgresql.acid.zalan.do
                key: username


          - name: PGPOOL_SR_CHECK_PASSWORD
            valueFrom:
              secretKeyRef:
                name: repmgr.psql-main.credentials.postgresql.acid.zalan.do
                key: password

          - name: PGPOOL_POSTGRES_USERNAME
            valueFrom:
              secretKeyRef:
                name: postgres.psql-main.credentials.postgresql.acid.zalan.do
                key: username

          - name: PGPOOL_POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres.psql-main.credentials.postgresql.acid.zalan.do
                key: password
          
          - name: PGPOOL_ENABLE_LOAD_BALANCING
            value: 'yes'

          - name: PGPOOL_ENABLE_LDAP
            value: 'yes'

          - name: LDAP_URI
            value: 'ldaps:ldap.mylogin.space:636'

          - name: LDAP_BASE
            value: 'ou=users,dc=ldap,dc=mylogin,dc=space'

          - name: LDAP_BIND_DN
            valueFrom:
              secretKeyRef:
                name: {{ .Release.Name }}-pgpool-aaa
                key: binddn

          - name: LDAP_BIND_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ .Release.Name }}-pgpool-aaa
                key: password

        volumeMounts:

          - name: tls
            mountPath: /tls

      volumes:
        - name: tls
          secret:
            defaultMode: 416
            secretName: myloginspace-default-certificates
