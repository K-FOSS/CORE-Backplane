apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: core-backplane-network-base
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - cluster: k0s-cntrl
            url: https://10.1.1.40:443
            apiHost: 10.1.1.40
            apiPort: '443'
            NICs: 'ens+'
            konnectivity: 'true'
            peers: | 
                - ip: 172.16.51.100/32
                  asn: 64567
                  port: 179

                - ip: 172.16.52.100/32
                  asn: 64567
                  port: 179

                - ip: 172.16.53.100/32
                  asn: 64567
                  port: 179

                - ip: 172.16.54.100/32
                  asn: 64567
                  port: 179

          - cluster: infra1-dc1
            url: https://172.20.52.1:6443
            apiHost: 172.20.52.1
            apiPort: '6443'
            konnectivity: 'false'
            NICs: 'bond0'
            peers: | 
                - ip: 172.31.241.69/32
                  asn: 64567
  template:
    metadata:
      name: '{{cluster}}-core-network-base'

    spec:
      project: core

      source:
        path: Network/Base
        repoURL: https://gitlab.git.writemy.codes/KJDev/CORE-Backplane.git
        targetRevision: HEAD
        plugin:
          name: argocd-lovely-plugin
          env:
            - name: LOVELY_HELM_MERGE
              value: |- 
                cilium:
                  k8sServiceHost: '{{ apiHost }}'
                  k8sServicePort: '{{ apiPort }}'

                  devices: '{{NICs}}'
                  
                  # -- Configure N-S k8s service loadbalancing
                  nodePort:
                    # -- Enable the Cilium NodePort service implementation.
                    enabled: true

                    # -- Port range to use for NodePort services.
                    # range: "30000,32767"

                    # -- Set to true to prevent applications binding to service ports.
                    bindProtection: true

                    directRoutingDevice: '{{NICs}}'

                    # -- Append NodePort range to ip_local_reserved_ports if clash with ephemeral
                    # ports is detected.
                    autoProtectPortRange: true

                    # -- Enable healthcheck nodePort server for NodePort services
                    enableHealthCheck: true


                konnectivity:
                  enabled: {{ konnectivity }}

                peers:
                {{peers}}



      destination:
        server: '{{url}}'
        namespace: kube-system
