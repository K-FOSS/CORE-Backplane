apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio-ingressgateway

  namespace: external-istiod
spec:
  profile: empty

  components:
    ingressGateways:
      - namespace: core-prod
        name: istio-ingressgateway
        enabled: true
        k8s:
          replicaCount: 4
          resources:
            requests:
              memory: '16M'
              cpu: '10m'

            limits:
              memory: '512M'
              cpu: '500m'

          hpaSpec:
            minReplicas: 2
            maxReplicas: 4

          priorityClassName: system-cluster-critical

          serviceAnnotations:
            metallb.universe.tf/allow-shared-ip: istio

          service:
            type: LoadBalancer
            loadBalancerIP: 10.1.1.83
            externalIPs:
              - {{ .Values.ingressGateway.publicIP }}

            ports:
              - name: status-port
                port: 15021
                targetPort: 15021

              - name: https
                port: 443
                targetPort: 443
                protocol: TCP

              - name: http
                port: 80
                targetPort: 80
                protocol: TCP

              - name: http-alt
                port: 8080
                targetPort: 8080
                protocol: TCP

              - name: http3
                port: 443
                targetPort: 443
                protocol: UDP
          
          overlays:
            - kind: Deployment
              name: istio-ingressgateway
              patches:
                - path: spec.template.spec.securityContext
                  value:
                    runAsUser: 0
                    runAsGroup: 0
                    runAsNonRoot: false
                    fsGroup: 0

                # Enable BPF for QUIC
                - path: spec.template.spec.containers.[name:istio-proxy].securityContext.capabilities.add
                  value:
                    - BPF

                # Evenly spread across nodes
                - path: spec.template.spec.topologySpreadConstraints
                  value:
                    - maxSkew: 1
                      topologyKey: kubernetes.io/hostname
                      whenUnsatisfiable: ScheduleAnyway
                      labelSelector:
                        matchLabels:
                          istio: ingressgateway
  
                - path: spec.template.spec.volumes.[-1]
                  value:
                    name: bpffs
                    hostPath:
                      path: /sys/fs/bpf
                      type: Directory

                - path: spec.template.spec.containers.[name:istio-proxy].volumeMounts.[-1]
                  value:
                    name: bpffs
                    mountPath: /sys/fs/bpf


                - path:  spec.template.metadata.labels.logs
                  value: loki-myloginspace
  
  values:
    gateways:
      istio-ingressgateway:
        injectionTemplate: gateway

        runAsRoot: true
        env:
          ISTIO_META_UNPRIVILEGED_POD: "false"

    global:
      istioNamespace: external-istiod
