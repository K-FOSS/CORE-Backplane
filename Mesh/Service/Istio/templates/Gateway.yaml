apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: external-istiod
  name: istio-ingressgateway

spec:
  profile: empty

  components:
    ingressGateways:
      - namespace: core-prod
        name: istio-ingressgateway
        enabled: true
        k8s:
          replicaCount: 5
          priorityClassName: system-cluster-critical
          serviceAnnotations:
            metallb.universe.tf/allow-shared-ip: istio
          service:
            type: LoadBalancer
            loadBalancerIP: 10.1.1.83
            externalIPs:
              - 66.165.222.101

            ports:
              - name: status-port
                port: 15021
                targetPort: 15021

              - name: https
                port: 443
                targetPort: 443
                protocol: TCP

              - name: http
                port: 80
                targetPort: 80
                protocol: TCP

              - name: http-alt
                port: 8080
                targetPort: 8080
                protocol: TCP

              - name: http3
                port: 443
                targetPort: 443
                protocol: UDP
          
          overlays:
            - kind: Deployment
              name: istio-ingressgateway
              patches:
                - path: spec.template.spec.securityContext
                  value:
                    runAsUser: 0
                    runAsGroup: 0
                    runAsNonRoot: false
                    fsGroup: 0

                # Enable BPF for QUIC
                - path: spec.template.spec.containers.[name:istio-proxy].securityContext.capabilities.add
                  value:
                    - BPF
  
                - path: spec.template.spec.volumes.[-1]
                  value:
                    name: bpffs
                    hostPath:
                      path: /sys/fs/bpf
                      type: Directory

                - path: spec.template.spec.containers.[name:istio-proxy].volumeMounts.[-1]
                  value:
                    name: bpffs
                    mountPath: /sys/fs/bpf

                - path: spec.template.spec.volumes.[name:istio-token].projected.sources.[0].serviceAccountToken
                  value:
                    path: istio-token
                    expirationSeconds: 43200
                    audience: istio-ca
  
  values:
    gateways:
      istio-ingressgateway:
        injectionTemplate: gateway

        runAsRoot: true
        env:
          ISTIO_META_UNPRIVILEGED_POD: "false"

    global:
      istioNamespace: external-istiod
