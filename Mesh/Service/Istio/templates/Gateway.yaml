apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: external-istiod
  name: istio-ingressgateway

spec:
  profile: empty
  meshConfig:
    accessLogFile: /dev/stdout
    enableTracing: true
    extensionProviders:
      - name: otel
        envoyOtelAls:
          service: otel-core.core-prod.svc.k0s.resolvemy.host
          port: 4317

    defaultProviders:
      accessLogging:
      - envoy
      - otel


  components:
    ingressGateways:
      - namespace: core-prod
        name: istio-ingressgateway
        enabled: true
        k8s:
          replicaCount: 3
          serviceAnnotations:
            metallb.universe.tf/allow-shared-ip: istio
          service:
            type: LoadBalancer
            loadBalancerIP: 10.1.1.83
            externalIPs:
              - 66.165.222.101

            ports:
              - name: status-port
                port: 15021
                targetPort: 15021

              - name: https
                port: 443
                targetPort: 443
                protocol: TCP

              - name: http
                port: 80
                targetPort: 80
                protocol: TCP

              - name: http-alt
                port: 8080
                targetPort: 8080
                protocol: TCP

              - name: http3
                port: 443
                targetPort: 443
                protocol: UDP
        

  values:
    gateways:
      istio-ingressgateway:
        injectionTemplate: gateway

        runAsRoot: true
        env:
          ISTIO_META_UNPRIVILEGED_POD: "false"

    global:
      istioNamespace: external-istiod
