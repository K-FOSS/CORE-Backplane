apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: development-gitlab-s3-backups-{{ .Values.secretSuffix }}-sync
spec:
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: gitlab-s3-backups-{{ .Values.secretSuffix }}
    template:
      engineVersion: v2
      data:
        # multiline string
        config: |
          [default]
          # Setup endpoint: hostname of the Web App
          host_base = https://s3.mylogin.space
          host_bucket = https://s3.mylogin.space
          # Leave as default
          bucket_location = us-east-1
          use_https = True
          multipart_chunk_size_mb = 128 # default is 15 (MB)

          # Setup access keys
          # Access Key = Azure Storage Account name
          access_key = gitlab
          # Secret Key = Azure Storage Account Key
          secret_key = {{`{{ .S3SecretKey }}`}}

          # Use S3 v4 signature APIs
          signature_v2 = False
  data:
    - secretKey: S3SecretKey
      remoteRef:
        key: GitLab
        property: S3SecretKey

