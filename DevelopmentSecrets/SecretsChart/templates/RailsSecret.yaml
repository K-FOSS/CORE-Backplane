apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: development-gitlab-rails-{{ .Values.secretSuffix }}-sync
spec:
  refreshInterval: '5m'
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: gitlab-prod-rails-secret
    template:
      engineVersion: v2
      data:
        # multiline string
        secrets.yml: |
          production:
            secret_key_base: {{`{{ .SecretKeyBase }}`}}
            otp_key_base: {{` .OTPKeyBase `}}
            db_key_base: {{`{{ .DBKeyBase }}`}}
            encrypted_settings_key_base: {{`{{ .EncryptedSettingsKeyBase }}`}}
  data:
    - secretKey: EncryptedSettingsKeyBase
      remoteRef:
        key: GitLab
        property: EncryptedSettingsKeyBase

    - secretKey: SecretKeyBase
      remoteRef:
        key: GitLab
        property: SecretKeyBase

    - secretKey: OTPKeyBase
      remoteRef:
        key: GitLab
        property: OTPKeyBase

    - secretKey: DBKeyBase
      remoteRef:
        key: GitLab
        property: DBKeyBase
