{{- if .Values.netmaker.server.enabled }}
{{- $fullName := include "meshnet.fullname" . -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: {{ $fullName }}

    app.kubernetes.io/name: netmaker
    app.kubernetes.io/component: server

    {{- with .Values.netmaker.server.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}

  {{- with .Values.netmaker.server.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  name: {{ $fullName }}-netmaker-server

spec:
  replicas: {{ .Values.netmaker.server.replicaCount }}

  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ $fullName }}

      app.kubernetes.io/name: netmaker
      app.kubernetes.io/component: server

  strategy:
    type: Recreate

  template:
    metadata:
      labels:
        app.kubernetes.io/instance: {{ $fullName }}

        app.kubernetes.io/name: netmaker
        app.kubernetes.io/component: server

        {{- with .Values.netmaker.server.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      {{- with .Values.netmaker.server.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

    spec:
      {{- with .Values.netmaker.server.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.netmaker.server.tolerations }}
      tolerations:
      {{- toYaml . | nindent 6 }}
      {{- end }}

      containers:
        - name: netmaker-server

          {{- with .Values.netmaker.server.image }}
          image: '{{ .repository }}{{ if .digest }}@{{ .digest }}{{ else }}:{{ .tag }}{{ end }}'
          imagePullPolicy: {{ .pullPolicy }}
          {{- end }}

          args: []

          resources:
            {{- toYaml .Values.netmaker.server.resources | nindent 12 }}

          env:
            - name: PLATFORM
              value: Kubernetes

            - name: API_PORT
              value: '8080'

            - name: REST_BACKEND
              value: 'on'

            - name: NODE_ID
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name

            - name: MESSAGEQUEUE_BACKEND
              value: 'off'

            - name: MANAGE_IPTABLES
              value: 'off'

            - name: DNS_MODE
              value: 'off'

            #
            # Auth
            #
            - name: AUTH_PROVIDER
              value: oidc

            - name: OIDC_ISSUER
              value: https://idp.mylogin.space/application/o/netmaker/

            - name: CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-oidc
                  key: OIDCClientID
                  optional: false

            - name: CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-oidc
                  key: OIDCClientSecret
                  optional: false


            
            #
            # Database
            #

            - name: DATABASE
              value: postgres

            - name: SQL_HOST
              value: {{ .Values.netmaker.database.host }}

            - name: SQL_PORT
              value: '{{ .Values.netmaker.database.port }}'

            - name: SQL_DB
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-db
                  key: Database
                  optional: false

            - name: SQL_USER
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-db
                  key: Username
                  optional: false

            - name: SQL_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-db
                  key: Password
                  optional: false


          ports:
            - containerPort: 8080
              name: http


        {{ range untilStep (.Values.netmaker.server.wireguard.min|int) (.Values.netmaker.server.wireguard.max|int) 1 }}
            - name: 'udp-{{ . }}'
              containerPort: {{ . }}
              protocol: UDP

            - name: 'tcp-{{ . }}'
              containerPort: {{ . }}
              protocol: TCP
        {{ end }}


        {{- with .Values.netmaker.server.sidecars }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      securityContext:
        seccompProfile:
          type: RuntimeDefault

{{- end }}
