apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: TalosControlPlane
metadata:
  name: talos-cp
spec:
  version: v1.18.1
  replicas: 1
  infrastructureTemplate:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: TinkerbellMachineTemplate
    name: kub-poc-control-plane
  controlPlaneConfig:
    controlplane:
      generateType: controlplane
---
apiVersion: tinkerbell.org/v1alpha1
kind: Hardware
metadata:
  name: infra2

  labels:
    idrac-version: '6'
    manufacturer: dell
    resolvemy.host/dc: '1'
    resolvemy.host/machinetype: baremetal    
    resolvemy.host/rack: '1'  

spec:
  disks:
    - device: /dev/sda

  interfaces:
    - dhcp:
        arch: x86_64
        hostname: infra2
        ip:
          address: 172.16.20.140
          gateway: 172.16.20.254
          netmask: 255.255.255.0
        lease_time: 86400
        mac: f0:4d:a2:09:60:ba
        name_servers:
          - 1.1.1.1
          - 1.0.0.1
      disableDhcp: false
      netboot:
        allowPXE: true
        allowWorkflow: false
        ipxe:
          contents: | # shell
            #!ipxe

            imgfree
            kernel https://pxe.factory.talos.dev/image/53f71594e53cf7e1ef9b01a7e8a9494858a88814485406d07d7bc663a555953d/v1.10.0-alpha.1/kernel-amd64 talos.platform=metal console=tty0 init_on_alloc=1 slab_nomerge pti=on consoleblank=0 nvme_core.io_timeout=4294967295 printk.devkmsg=on ima_template=ima-ng ima_appraise=fix ima_hash=sha512 selinux=1
            initrd https://pxe.factory.talos.dev/image/53f71594e53cf7e1ef9b01a7e8a9494858a88814485406d07d7bc663a555953d/v1.10.0-alpha.1/initramfs-amd64.xz
            boot
  metadata:
    facility:
      facility_code: onprem
    instance:
      hostname: infra2
      id: f0:4d:a2:09:60:ba
    manufacturer:
      slug: dell
---
apiVersion: tinkerbell.org/v1alpha1
kind: Template
metadata:
  name: infra2

spec:
  data: | # yaml
    version: "0.1"
    name: kub-poc-control-plane-flatcar-arm64
    global_timeout: 6000
    tasks:
      - name: "kub-poc-control-plane-flatcar"
        worker: "{{`{{.device_1}}`}}"
        volumes:
          - /dev:/dev
          - /dev/console:/dev/console
          - /lib/firmware:/lib/firmware:ro
          - /run:/run
        actions:
          - name: "stream ubuntu"
            image: docker.io/zhaog918/qemuimg2disk:v1.0.0
            timeout: 1800
            environment:
                IMG_URL: https://alpha.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img
                DEST_DISK: /dev/sda

          - name: "change-kernel-configuration"
            image: quay.io/tinkerbell-actions/writefile:v1.0.0
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: btrfs
              DEST_PATH: /grub.cfg
              UID: 0
              GID: 0
              MODE: 0777
              DIRMODE: 0755
              CONTENTS: |
                set linux_append="$linux_append flatcar.autologin=tty1 flatcar.config.url=http://10.1.1.66:50061/2009-04-04/user-data"

---
apiVersion: tinkerbell.org/v1alpha1
kind: Workflow
metadata:
  name: infra2

spec:
  bootOptions:
    toggleAllowNetboot: true
    bootMode: iso
  hardwareMap:
    device_1: f0:4d:a2:09:60:ba
  hardwareRef: infra2
  templateRef: infra2