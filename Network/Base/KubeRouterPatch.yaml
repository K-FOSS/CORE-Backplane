apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-router
  namespace: kube-system
spec:
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
  template:
    spec:
      containers:
        - name: kube-router

          image: 'docker.io/cloudnativelabs/kube-router:v1.5.0'
          imagePullPolicy: IfNotPresent

          args:
            #
            # TODO
            # 
            - '--master='

            - --enable-pprof=false

            #
            # Routes and Syncing
            #
            - --cache-sync-timeout=15s
            - --routes-sync-period=30s

            #
            # Peers
            #
            
            {{- $peerIPs := list -}}
            {{- $peerASNs := list -}}
            {{ range .Values.peers }}
              {{- $peerIPs = .ip | append $peerIPs -}}
              {{- $peerASNs = .asn | append $peerASNs -}}
            {{- end }}
            - --peer-router-ips={{ join "," $peerIPs }}
            - --peer-router-asns={{ join "," $peerASNs }}
            - --peer-router-multihop-ttl=2
            

            #
            # NAT
            #
            - --masquerade-all=false


            #
            # iBGP
            #
            - --enable-ibgp=false
            - --nodes-full-mesh=false

            # CNI
            - --enable-cni=false
            - --cluster-asn=64512


            # Graceful Restart
            - --bgp-graceful-restart-deferral-time=1m
            - --bgp-graceful-restart=true

            #
            # Route Propagation Rules
            #
            - --advertise-pod-cidr=false
            - --advertise-loadbalancer-ip=true
            - --advertise-external-ip=true
            - --advertise-cluster-ip=true

            #
            # BGP Settings
            #
            - --override-nexthop=true
            - --bgp-port=179

            #
            # Misc Flags
            #
            - --run-router=true
            - --run-firewall=false
            - --run-service-proxy=false
            - --enable-pod-egress=false
            - --enable-overlay=false


          
          ports:
            - name: bgp
              containerPort: 179

            - name: health
              containerPort: 20244
          
          resources:
            limits:
              cpu: 250m
              memory: 250Mi
            requests:
              cpu: 250m
              memory: 250Mi

          securityContext:
            privileged: true

      hostNetwork: false



      initContainers: null
      priorityClassName: system-node-critical


