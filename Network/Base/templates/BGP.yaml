{{- if index .Values "kube-router" "enabled" }} 
apiVersion: "cilium.io/v2alpha1"
kind: CiliumBGPPeeringPolicy
metadata:
  name: 01-bgp-peering-policy
spec: # CiliumBGPPeeringPolicySpec
  nodeSelector:
    matchLabels:
      resolvemy.host/machinetype: vm

  virtualRouters:
    - exportPodCIDR: true
      localASN: 64512
      neighbors:
      {{ range .Values.peers }}
        - connectRetryTimeSeconds: 120
          eBGPMultihopTTL: 1
          gracefulRestart:
            enabled: true
            restartTimeSeconds: 120

          holdTimeSeconds: 90
          keepAliveTimeSeconds: 30
          peerASN: {{ .asn }}
          peerAddress: {{ .ip }}/24
          peerPort: {{ .port }}
      {{- end }}

      serviceSelector:
        matchExpressions:
          - key: io.kubernetes.service.namespace
            operator: NotIn
            values:
              - test
{{- end }}
