apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: core-backplane-network-infra-externaldns-cf-helm
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - cluster: k0s-cntrl
            url: https://10.1.1.40:443
  template:
    metadata:
      name: '{{cluster}}-externaldns-cf-helm'
    spec:
      project: core
      syncPolicy:
        automated:
          selfHeal: true
      source:
        repoURL: https://kubernetes-sigs.github.io/external-dns/
        chart: external-dns
        path: external-dns
        targetRevision: 1.9.0
        helm:
          releaseName: externaldns-cf-core
          values: |
            image:
              repository: k8s.gcr.io/external-dns/external-dns
              pullPolicy: IfNotPresent

            imagePullSecrets: []
            nameOverride: ""
            fullnameOverride: ""

            serviceAccount:
              # Specifies whether a service account should be created
              create: true
              # Annotations to add to the service account
              annotations: {}    

            rbac:
              # Specifies whether RBAC resources should be created
              create: true
              additionalPermissions: {}

            podLabels:
              logs: loki-myloginspace

            podAnnotations: {}

            podSecurityContext:
              fsGroup: 65534

            securityContext:
              runAsNonRoot: true
              runAsUser: 65534
              readOnlyRootFilesystem: true
              capabilities:
                drop: ['ALL']

            priorityClassName: ''

            terminationGracePeriodSeconds:

            serviceMonitor:
              enabled: false
              additionalLabels: {}
              interval: 1m
              scrapeTimeout: 10s

            env:
              - name: CF_API_TOKEN
                valueFrom:
                  secretKeyRef:
                    key: Token
                    name: kjdev-cloudflare

            livenessProbe:
              httpGet:
                path: /healthz
                port: http
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 2
              successThreshold: 1

            readinessProbe:
              httpGet:
                path: /healthz
                port: http
              initialDelaySeconds: 5
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 6
              successThreshold: 1

            service:
              port: 7979
              annotations: {}

            extraVolumes: []

            extraVolumeMounts: []

            resources: {}

            nodeSelector: {}

            tolerations: []

            affinity: {}

            logLevel: info
            logFormat: json

            interval: 1m
            triggerLoopOnEvent: false

            sources:
              - service
              - ingress
              - istio-gateway

            policy: upsert-only

            registry: txt
            txtOwnerId: 'k0s-dc1'
            txtPrefix: ''
            txtSuffix: ''

            domainFilters: []

            provider: cloudflare

            extraArgs: ['--label-filter=wan-mode=public']


      destination:
        server: '{{url}}'
        namespace: core-prod
