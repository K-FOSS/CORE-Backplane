apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: core-backplane-network-infra-awx-helm
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - cluster: k0s-cntrl
            url: https://k0s-dc1-kubernetes-default.service.dc1.kjdev:6443
  template:
    metadata:
      name: '{{cluster}}-awx-helm'
    spec:
      project: core
      syncPolicy:
        automated:
          selfHeal: true
      source:
        repoURL: https://adwerx.github.io/charts
        chart: awx
        path: awx 
        targetRevision: 3.4.2
        helm:
          releaseName: awx
          values: |
            # Default values for awx
            # This is a YAML-formatted file.
            # Declare variables to be passed into your templates.

            nameOverride: ""
            fullnameOverride: ""

            replicaCount: 0
            image:
              repository: quay.io/ansible/awx
              tag: 20.0.1
              pullPolicy: IfNotPresent
            extraVolumes: []
            web:
              resources: {}
                # We usually recommend not to specify default resources and to leave this as a conscious
                # choice for the user. This also increases chances charts run on environments with little
                # resources, such as Minikube. If you do want to specify resources, uncomment the following
                # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
                # limits:
                #  cpu: "1"
                #  memory: "1Gi"
                # requests:
                #  cpu: "1"
                #  memory: "1Gi"
              extraVolumeMounts: []
              extraVolumes: []

            task:
              resources: {}
                # We usually recommend not to specify default resources and to leave this as a conscious
                # choice for the user. This also increases chances charts run on environments with little
                # resources, such as Minikube. If you do want to specify resources, uncomment the following
                # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
                # limits:
                #  cpu: "1.5"
                #  memory: "2Gi"
                # requests:
                #  cpu: "1.5"
                #  memory: "2Gi"
              extraVolumeMounts: []

            redis:
              image:
                repository: redis
                tag: "6.2.4"
                pullPolicy: IfNotPresent
              resources: {}

            # -- The name of an existing secret in the same namespace containing a SECRET_KEY key and value
            secretKeyExistingSecret: awx-secretkey

            # -- The name of an existing secret in the same namespace containing `AWX_ADMIN_USER` and `AWX_ADMIN_PASSWORD` keys and values
            defaultAdminExistingSecret: awx-admin

            extraConfiguration: |-
              # INSIGHTS_URL_BASE = "https://example.org"

            service:
              type: ClusterIP
              port: 8080

            ingress:
              enabled: false
              # -- Whether the default backend for this ingress should route to the awx service
              defaultBackend: false
              # -- Define ingress routing here
              hosts:
                - host: awx.int.mylogin.space
                  paths:
                    - /
              annotations:
                traefik.ingress.kubernetes.io/router.entrypoints: websecure
                traefik.ingress.kubernetes.io/router.middlewares: core-prod-pomerium-auth@kubernetescrd
                traefik.ingress.kubernetes.io/router.tls: "true"
                ingress.pomerium.io/allowed_idp_claims: '{"groups": ["Server", "Network"]}'
                ingress.pomerium.io/pass_identity_headers: "true"
              tls:
                - secretName: myloginspace-int-default-certificates
                  hosts:
                    - '*.int.mylogin.space'

            # -- See bitnami/postgresql chart values for all options
            postgresql:
              # -- Set to false if using external postgresql
              enabled: false
              postgresqlHost: psql.service.kjdev
              persistence:
                enabled: false
                # size: 50Gi
              # resources: {}
              metrics:
                enabled: false

            # -- The name of an existing secret in the same namespace containing DATABASE_USER, DATABASE_NAME, DATABASE_HOST, DATABASE_HOST, DATABASE_PORT, DATABASE_PASSWORD, DATABASE_ADMIN_PASSWORD keys and values
            postgresqlExistingSecret: awx-database


      destination:
        server: '{{url}}'
        namespace: core-prod
