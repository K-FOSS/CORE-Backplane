---
# See: https://www.authelia.com/integration/kubernetes/istio/
#      https://www.envoyproxy.io/docs/envoy/v1.26.2/configuration/http/http_filters/ext_authz_filter#config-http-filters-ext-authz
#      https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html#extensions-filters-http-ext-authz-v3-extauthz
#      https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig-ExtensionProvider-EnvoyExternalAuthorizationHttpProvider
apiVersion: cilium.io/v2
kind: CiliumClusterwideEnvoyConfig
metadata:
  name: envoy-ext-authz-http
spec:
  backendServices:
    - name: authorino-authorino-authorization
      namespace: kuadrant-system
      number:
        - '50051'
    - name: s3-gw
      namespace: core-prod
      number:
        - '9000'
  resources:
    - '@type': type.googleapis.com/envoy.config.listener.v3.Listener
      filterChains:
        - filterChainMatch:
            transportProtocol: raw_buffer
          filters:
            - name: envoy.filters.network.http_connection_manager
              typedConfig:
                '@type': >-
                  type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                commonHttpProtocolOptions:
                  maxStreamDuration: 0s
                httpFilters:
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      grpc_service:
                        google_grpc:
                          statPrefix: listener-insecure
                          target_uri: >-
                            authorino-authorino-authorization.kuadrant-system.svc.k0s.resolvemy.host:50051
                      transport_api_version: V3
                  - name: envoy.filters.http.grpc_web
                    typedConfig:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
                  - name: envoy.filters.http.grpc_stats
                    typedConfig:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.grpc_stats.v3.FilterConfig
                      emitFilterState: true
                      enableUpstreamStats: true
                  - name: envoy.filters.http.router
                    typedConfig:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                rds:
                  routeConfigName: listener-insecure
                statPrefix: listener-insecure
                upgradeConfigs:
                  - upgradeType: websocket
                useRemoteAddress: true
      listenerFilters:
        - name: envoy.filters.listener.tls_inspector
          typedConfig:
            '@type': >-
              type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
      name: listener
      socketOptions:
        - description: Enable TCP keep-alive (default to enabled)
          intValue: '1'
          level: '1'
          name: '9'
          state: STATE_LISTENING
        - description: TCP keep-alive idle time (in seconds) (defaults to 10s)
          intValue: '10'
          level: '6'
          name: '4'
          state: STATE_LISTENING
        - description: TCP keep-alive probe intervals (in seconds) (defaults to 5s)
          intValue: '5'
          level: '6'
          name: '5'
          state: STATE_LISTENING
        - description: TCP keep-alive probe max failures.
          intValue: '10'
          level: '6'
          name: '6'
          state: STATE_LISTENING
    - '@type': type.googleapis.com/envoy.config.route.v3.RouteConfiguration
      name: listener-insecure
      virtual_hosts:
        - domains:
            - authorino.mylogin.space
          name: listener-insecure
          routes:
            - directResponse:
                body:
                  inlineString: http_filters
                status: 200
              match:
                prefix: /
  services:
    - listener: ''
      name: cilium-gateway-ingress-gw
      namespace: core-prod
