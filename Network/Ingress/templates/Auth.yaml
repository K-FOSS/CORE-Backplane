---
# See: https://www.authelia.com/integration/kubernetes/istio/
#      https://www.envoyproxy.io/docs/envoy/v1.26.2/configuration/http/http_filters/ext_authz_filter#config-http-filters-ext-authz
#      https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html#extensions-filters-http-ext-authz-v3-extauthz
#      https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig-ExtensionProvider-EnvoyExternalAuthorizationHttpProvider
apiVersion: cilium.io/v2
kind: CiliumClusterwideEnvoyConfig
metadata:
  name: envoy-ext-authz-http
spec:
  services:
    - listener: ''
      name: cilium-gateway-ingress-gw
      namespace: core-prod

  backendServices:
    - name: authorino-authorino-authorization
      namespace: kuadrant-system
      number:
        - '50051'

    - name: s3-gw
      namespace: core-prod
      number:
        - '9000'

  resources:
    - '@type': type.googleapis.com/envoy.config.listener.v3.Listener
      name: auth
      filterChains:
        - filterChainMatch:
            transportProtocol: raw_buffer
          filters:
            - name: envoy.filters.network.http_connection_manager
              typedConfig:
                '@type': >-
                  type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                commonHttpProtocolOptions:
                  maxStreamDuration: 0s
                httpFilters:
                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      '@type': type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      transport_api_version: V3
                      grpc_service:
                        google_grpc:
                          target_uri: authorino-authorino-authorization.kuadrant-system.svc.k0s.resolvemy.host:50051
                  - name: envoy.filters.http.grpc_web
                    typedConfig:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
                  - name: envoy.filters.http.grpc_stats
                    typedConfig:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.grpc_stats.v3.FilterConfig
                      emitFilterState: true
                      enableUpstreamStats: true
                  - name: envoy.filters.http.router
                    typedConfig:
                      '@type': >-
                        type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                rds:
                  routeConfigName: auth-insecure
                statPrefix: listener-insecure
                upgradeConfigs:
                  - upgradeType: websocket
                useRemoteAddress: true

    - '@type': type.googleapis.com/envoy.config.route.v3.RouteConfiguration
      name: auth-insecure
      virtual_hosts:
        - domains:
            - 'authorino.mylogin.space'
          name: auth-insecure
          routes:
            - match:
                prefix: /
              directResponse:
                body:
                  inlineString: http_filters
                status: 200
