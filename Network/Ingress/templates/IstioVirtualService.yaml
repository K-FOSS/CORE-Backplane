apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: istio-ingress
spec:
  hosts:
    - accessmyporn.download
    - resolvemy.host
    - controlcenter.house
    - outoftheworld.space
    - network.glass
    - trackmy.finance
    - ksit.services

    - '*.controlcenter.house'
    - '*.mylogin.space'
    - '*.writemy.codes'
    - '*.ipaddr.network'
    - '*.kjmedia.stream'
    - '*.kristianjones.dev'
    - '*.snd.fyi'
    - '*.outoftheworld.space'
    - '*.network.glass'
    - '*.trackmy.finance'
    - '*.ksit.services'

    # IP Addresses
    - 10.1.1.83
    - 66.165.222.101
  gateways:
    - core-gateway
  http:
    #########################################################
    #                                                       #
    #     Authentication Authorization Accounting (AAA)     #
    #                                                       #
    #########################################################

    #
    # Authentik
    #
    # Identity Platform
    #

    - match:
        - authority:
            exact: idp.mylogin.space

      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-aaa-authentik.core-prod.svc.k0s.resolvemy.host

    - match:
        - uri:
            prefix: /outpost.goauthentik.io
          ignoreUriCase: true
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-aaa-authentik.core-prod.svc.k0s.resolvemy.host


    #
    # IoT
    #

    - match:
        - authority:
            exact: controlcenter.house
      route:
        - destination:
            port:
              number: 8123
            host: hassio.core-prod.svc.k0s.resolvemy.host

    #
    # Family
    #
    - match:
        - authority:
            exact: grocy.controlcenter.house
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-business-family-grocy.core-prod.svc.k0s.resolvemy.host


    ################################
    #
    #      Storage and Delivery
    #
    ################################


    #
    # S3 Object Storage
    #

    - name: minio
      match:
        - authority:
            exact: s3.mylogin.space
      route:
        - destination:
            port:
              number: 443
            host: s3-minio.core-prod.svc.k0s.resolvemy.host

    - name: minio-dashboard
      match:
        - authority:
            exact: s3.int.mylogin.space
      route:
        - destination:
            port:
              number: 9443
            host: kjdev-core-console.core-prod.svc.k0s.resolvemy.host


    ###################################
    #  Content Delivery and Caching   #
    ###################################


    #
    # Static Files/CDN
    #

    - name: wip-static-cdn
      match:
        - authority:
            exact: static.mylogin.space

        - port: 80
          authority:
            exact: 10.1.1.83

      route:
        - destination:
            port:
              number: 80
            host: traefik-core-s3-proxy.core-prod.svc.k0s.resolvemy.host

    #
    # Media Streaming
    #

    - match:
        - authority:
            exact: jellyfin.kjmedia.stream
      route:
        - destination:
            port:
              number: 8096
            host: jellyfin-core.lab-prod.svc.k0s.resolvemy.host

    #
    # Stash
    #

    - match:
        - authority:
            exact: accessmyporn.download
      route:
        - destination:
            port:
              number: 9999
            host: stash-core.lab-prod.svc.k0s.resolvemy.host

    #
    # Quick Sharing
    #
    - match:
        - authority:
            exact: share.kjmedia.stream
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-business-sharing-xbackbone.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: network.glass
          
        - authority:
            exact: outoftheworld.space

      directResponse:
        status: 200
        body:
          string: 'TODO'

    - match:
        - authority:
            exact: ksit.services

      directResponse:
        status: 200
        body:
          string: |
            Kristine's IT Services

    #
    # Speed Test and Connectivity Testing  
    #

    - match:
        - authority:
            exact: speed.kjmedia.stream
      route:
        - destination:
            port:
              number: 80
            host: speed.kjmedia.stream

    
    #
    # Status
    #
    - match:
        - authority:
            exact: uptime.writemy.codes
      route:
        - destination:
            port:
              number: 3001
            host: k0s-cntrl-observability-monitoring-uptime-kuma.core-prod.svc.k0s.resolvemy.host
    
    #
    # Development 
    #
    - match:
        - headers:
            host:
              regex: '.*.git.writemy.codes'
      route:
        - destination:
            port:
              number: 8181
            host: gitlab-prod-webservice-default.core-prod.svc.k0s.resolvemy.host

    #
    # ArgoCD
    #
    - match:
        - authority:
            exact: 'argo.writemy.codes'
          headers:
            content-type:
              exact: application/grpc
      route:
        - destination:
            port:
              number: 8080
            host: core-argocd-server-grpc.argocd.svc.k0s.resolvemy.host


    - match:
        - authority:
            exact: 'argo.writemy.codes'
      route:
        - destination:
            port:
              number: 8080
            host: core-argocd-server.argocd.svc.k0s.resolvemy.host


    #
    # ArtifactHub
    #
    - match:
        - authority:
            exact: 'artifacthub.int.mylogin.space'

      route:
        - destination:
            port:
              number: 80
            host: hub.core-prod.svc.k0s.resolvemy.host


    #
    # Registry
    #

    - match:
        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /api/
          ignoreUriCase: true

        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /service/
          ignoreUriCase: true
        
        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /v2
          ignoreUriCase: true

        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /chartrepo/
          ignoreUriCase: true

        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /c/
          ignoreUriCase: true
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-development-harbor-helm-core.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: 'registry.writemy.codes'
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-development-harbor-helm-portal.core-prod.svc.k0s.resolvemy.host

    #############################
    #                           #
    #            AVoIP          #
    #                           #
    #############################

    
    #
    # Jitsi Meet Video System
    #

    - name: jitsi
      match:
        - authority:
            exact: meet.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-business-avoip-jitsi-meet-web.core-prod.svc.k0s.resolvemy.host



    ###################################
    #                                 #
    #           Observability         #
    #                                 #
    ###################################

    ####################
    #                  #
    #     Business     #
    #                  #
    ####################

    
    #
    # Education
    #
    - match:
        - authority:
            exact: edu.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-business-education-moodle.core-prod.svc.k0s.resolvemy.host

    #
    # Knowledge
    #

    - match:
        - authority:
            exact: contextualise.writemy.codes
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-business-knowledge-knowledge-contextualise.core-prod.svc.k0s.resolvemy.host
    
    #
    # NextCloud/Office/Docs/Sheets/Slides/Notes/Chat/Talk/Mail
    #

    - match:
        - authority:
            exact: office.mylogin.space

          uri:
            exact: /.well-known/carddav
      
        - authority:
            exact: office.mylogin.space

          uri:
            exact: /.well-known/caldav
      rewrite:
        uri: /remote.php/dav
      route:
        - destination:
            port:
              number: 8080
            host: k0s-cntrl-business-office-nextcloud.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: office.mylogin.space

          uri:
            prefix: /.well-known/webfinger
      rewrite:
        uri: /index.php/.well-known/webfinger
      route:
        - destination:
            port:
              number: 8080
            host: k0s-cntrl-business-office-nextcloud.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: office.mylogin.space

          uri:
            prefix: /.well-known/nodeinfo
      rewrite:
        uri: /index.php/.well-known/nodeinfo
      route:
        - destination:
            port:
              number: 8080
            host: k0s-cntrl-business-office-nextcloud.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: office.mylogin.space
      route:
        - destination:
            port:
              number: 8080
            host: k0s-cntrl-business-office-nextcloud.core-prod.svc.k0s.resolvemy.host


    #
    # Documents
    # 

    - match:
        - authority:
            exact: collabora.mylogin.space
      route:
        - destination:
            port:
              number: 9980
            host: k0s-cntrl-business-office-collabora-code.core-prod.svc.k0s.resolvemy.host

    #
    # Outline/Notion
    #
    - match:
        - authority:
            exact: outline.mylogin.space
      route:
        - destination:
            port:
              number: 10196
            host: k0s-cntrl-business-knowledge-outline.core-prod.svc.k0s.resolvemy.host

    #
    # Projects
    #

    - match:
        - authority:
            exact: projects.mylogin.space
      route:
        - destination:
            port:
              number: 8080
            host: openproject-svc.core-prod.svc.k0s.resolvemy.host


    #
    # Drawing
    # 
    - match:
        - authority:
            exact: draw.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: drawio-ui.core-prod.svc.k0s.resolvemy.host


    #
    # CyberChef
    #
    - match:
        - authority:
            exact: cyberchef.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: cyberchef-ui.core-prod.svc.k0s.resolvemy.host


    #
    # Bitwarden/Vaultwarden Password Manager
    #
    - match:
        - authority:
            exact: bitwarden.kristianjones.dev
          uri:
            prefix: /notifications/hub
          ignoreUriCase: true

        - authority:
            exact: passwords.mylogin.space
          uri:
            prefix: /notifications/hub
          ignoreUriCase: true

      route:
        - destination:
            port:
              number: 3012
            host: k0s-cntrl-business-passwords-vaultwarden.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: bitwarden.kristianjones.dev

        - authority:
            exact: passwords.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-business-passwords-vaultwarden.core-prod.svc.k0s.resolvemy.host

    #
    # Mattermost/Teams/Chat/ChatOps/Notifications/Bots
    #

    - match:
        - authority:
            exact: teams.mylogin.space
      route:
        - destination:
            port:
              number: 8080
            host: mattermost-team-edition.core-prod.svc.k0s.resolvemy.host



    #
    # Mail
    #
    - match:
        - authority:
            exact: simplelogin.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: simplelogin-api.core-prod.svc.k0s.resolvemy.host


    ###########################
    #
    #       Infrastructure
    #
    ############################


    #
    # Rancher Kubernetes Administration and Management
    #

    - match:
        - authority:
            exact: rancher.int.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-rancher.cattle-system.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: 'consul.int.mylogin.space'

      route:
        - destination:
            port:
              number: 80
            host: k0s-dc1-ui.core-prod.svc.k0s.resolvemy.host
          weight: 100

    - match:
        - authority:
            exact: 'vault.int.mylogin.space'

      route:
        - destination:
            port:
              number: 8200
            host: vault-core.core-prod.svc.k0s.resolvemy.host
          weight: 100



    ########################
    #
    #       Networking
    #
    #########################


    #
    # Unifi Network Management
    #
    - match:
        - port: 8080
          authority:
            exact: 10.1.1.83

      route:
        - destination:
            port:
              number: 8080
            host: unifi-ingress.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: unifi.ipaddr.network

      route:
        - destination:
            port:
              number: 80
            host: unifi-ingress.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: awx.int.mylogin.space

      route:
        - destination:
            port:
              number: 8080
            host: awx.core-prod.svc.k0s.resolvemy.host

    #
    # Netbox
    #
    - match:
        - authority:
            exact: ipam.ipaddr.network
          headers:
            content-length:
              regex: '\d*'
      route:
        - destination:
            port:
              number: 8080
            host: core-netbox-ipam.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: ipam.ipaddr.network

      route:
        - destination:
            port:
              number: 8080
            host: core-netbox-ipam.core-prod.svc.k0s.resolvemy.host
          headers:
            request:
              add:
                content-length: '0'


    - match:
        - authority:
            exact: db.mylogin.space
      route:
        - destination:
            port:
              number: 443
            host: bytebase.core-prod.svc.k0s.resolvemy.host


    - match:
        - authority:
            exact: wwwsql.mylogin.space
      route:
        - destination:
            port:
              number: 80
            host: bytebase.core-prod.svc.k0s.resolvemy.host

  tls:
    #
    # Traefik
    # 
    - match:
        - port: 443
          sniHosts:
            - resolvemy.host
      route:
        - destination:
            host: traefik-core.core-prod.svc.k0s.resolvemy.host
            port:
              number: 443
          weight: 100


    #
    # GitPods Development Environments
    #

    - match:
        - port: 443
          sniHosts:
            - gitpods.writemy.codes
            - '*.gitpods.writemy.codes'
      route:
        - destination:
            host: proxy.core-prod.svc.k0s.resolvemy.host
            port:
              number: 443
          weight: 100
