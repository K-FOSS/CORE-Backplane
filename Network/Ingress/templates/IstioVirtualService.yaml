apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: istio-ingress
spec:
  hosts:
    - '*.mylogin.space'
    - '*.writemy.codes'
  gateways:
    - core-gateway
  http:
    #########################################################
    #                                                       #
    #     Authentication Authorization Accounting (AAA)     #
    #                                                       #
    #########################################################

    #
    # Authentik
    #
    # Identity Platform
    #

    - match:
        - authority:
            exact: idp.mylogin.space

      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-aaa-authentik.core-prod.svc.k0s.resolvemy.host

    - match:
        - uri:
            prefix: /outpost.goauthentik.io
          ignoreUriCase: true
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-aaa-authentik.core-prod.svc.k0s.resolvemy.host



    ################################
    #
    #      Storage and Delivery
    #
    ################################


    #
    # S3 Object Storage
    #

    - name: minio
      match:
        - authority:
            exact: s3.mylogin.space

        - authority:
            regex: '.*\.s3.mylogin\.space'
      route:
        - destination:
            port:
              number: 9000
            host: kjdev-core-hl.core-prod.svc.k0s.resolvemy.host

    - name: minio-dashboard
      match:
        - authority:
            exact: s3.int.mylogin.space
      route:
        - destination:
            port:
              number: 9090
            host: kjdev-core-console.core-prod.svc.k0s.resolvemy.host


    #
    # Development 
    #
    - match:
        - headers:
            host:
              regex: '.*.git.writemy.codes'
      route:
        - destination:
            port:
              number: 8181
            host: k0s-cntrl-development-webservice-default.core-prod.svc.k0s.resolvemy.host

    #
    # ArgoCD
    #


    - match:
        - authority:
            exact: 'argo.writemy.codes'
      route:
        - destination:
            port:
              number: 80
            host: argocd-server.argocd.svc.k0s.resolvemy.host


    #
    # ArtifactHub
    #
    - match:
        - authority:
            exact: 'artifacthub.int.mylogin.space'

      route:
        - destination:
            port:
              number: 80
            host: hub.core-prod.svc.k0s.resolvemy.host


    #
    # Registry
    #

    - match:
        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /api/
          ignoreUriCase: true

        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /service/
          ignoreUriCase: true
        
        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /v2
          ignoreUriCase: true

        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /chartrepo/
          ignoreUriCase: true

        - authority:
            exact: 'registry.writemy.codes'
          uri:
            prefix: /c/
          ignoreUriCase: true
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-development-harbor-helm-core.core-prod.svc.k0s.resolvemy.host

    - match:
        - authority:
            exact: 'registry.writemy.codes'
      route:
        - destination:
            port:
              number: 80
            host: k0s-cntrl-development-harbor-helm-portal.core-prod.svc.k0s.resolvemy.host






          

    - match:
        - authority:
            exact: 'corevault.int.mylogin.space'

      route:
        - destination:
            port:
              number: 8200
            host: infra1-dc1-corevault-active.core-prod.svc.k0s.resolvemy.host
          weight: 100


    - match:
        - authority:
            exact: 'vault.int.mylogin.space'

      route:
        - destination:
            port:
              number: 8200
            host: infra1-dc1-vault-active.core-prod.svc.k0s.resolvemy.host
          weight: 100


