apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: grafana-auth
  namespace: kuadrant-core-prod
spec:
  jsonPatches:
    - name: kuadrant-core-prod/main-gw/https
      operation:
        op: add
        path: /virtual_hosts/0
        value:
          domains:
            - grafana.int.mylogin.space
          name: grafana-core
          routes:
            - match:
                prefix: /outpost.goauthentik.io
              name: staticmain
              route:
                cluster: httproute/kube-system/authentik/rule/0
            - match:
                prefix: /
              metadata:
                filter_metadata:
                  envoy.filters.http.lua:
                    mykey_flow1: true
              name: grafana-core
              route:
                cluster: httproute/core-prod/grafana-core/rule/0
      type: type.googleapis.com/envoy.config.route.v3.RouteConfiguration
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: main-gw
    namespace: kuadrant-core-prod
  type: JSONPatch

