{{- if .Values.netmaker.server.enabled }}
{{- $fullName := include "pnetwork.fullname" . -}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: {{ $fullName }}

    app.kubernetes.io/name: netmaker
    app.kubernetes.io/component: server

    {{- with .Values.netmaker.server.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}

  {{- with .Values.netmaker.server.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  name: {{ $fullName }}-netmaker-server

spec:
  replicas: {{ .Values.netmaker.server.replicaCount }}

  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ $fullName }}

      app.kubernetes.io/name: netmaker
      app.kubernetes.io/component: server

  strategy:
    type: Recreate

  template:
    metadata:
      labels:
        app.kubernetes.io/instance: {{ $fullName }}

        app.kubernetes.io/name: netmaker
        app.kubernetes.io/component: server

        {{- with .Values.netmaker.server.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      {{- with .Values.netmaker.server.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

    spec:
      {{- with .Values.netmaker.server.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.netmaker.server.tolerations }}
      tolerations:
      {{- toYaml . | nindent 6 }}
      {{- end }}

      volumes:
        - name: test-volume
          emptyDir: {}

        - name: config-vol
          configMap:
            name: {{ $fullName }}-netmaker-server-config
            defaultMode: 0755
            items:
              - key: mosquitto.conf
                path: mosquitto.conf

              - key: wait.sh
                path: wait.sh

      containers:
        - name: netmaker-server

          {{- with .Values.netmaker.server.image }}
          image: '{{ .repository }}{{ if .digest }}@{{ .digest }}{{ else }}:{{ .tag }}{{ end }}'
          imagePullPolicy: {{ .pullPolicy }}
          {{- end }}

          args: []

          securityContext:
            capabilities:
              add:
              - NET_ADMIN
              - NET_RAW
              - SYS_MODULE
      
          volumeMounts:
            - mountPath: /etc/netmaker
              name: test-volume

          resources:
            {{- toYaml .Values.netmaker.server.resources | nindent 12 }}

          env:
            - name: PLATFORM
              value: Kubernetes

            - name: FRONTEND_URL
              value: https://mesh.ipaddr.network

            - name: SERVER_API_CONN_STRING
              value: meshapi.ipaddr.network:443

            - name: CORS_ALLOWED_ORIGIN
              value: '*'

            - name: SERVER_HTTP_HOST
              value: meshapi.ipaddr.network

            - name: SERVER_HOST
              value: 66.165.222.101

            - name: API_PORT
              value: '8080'

            - name: REST_BACKEND
              value: 'on'

            - name: AGENT_BACKEND
              value: 'on'

            - name: NODE_ID
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name

            - name: MESSAGEQUEUE_BACKEND
              value: 'on'

            - name: MANAGE_IPTABLES
              value: 'off'

            - name: DNS_MODE
              value: 'off'

            - name: MQ_HOST
              value: '127.0.0.1'

            - name: MQ_SERVER_PORT
              value: '1883'

            - name: MQ_ADMIN_PASSWORD
              value: 'public'

            

            #
            # Auth
            #
            - name: AUTH_PROVIDER
              value: oidc

            - name: OIDC_ISSUER
              value: https://idp.mylogin.space/application/o/netmaker/

            - name: CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-oidc
                  key: OIDCClientID
                  optional: false

            - name: CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-oidc
                  key: OIDCClientSecret
                  optional: false


            
            #
            # Database
            #

            - name: DATABASE
              value: postgres

            - name: SQL_HOST
              value: {{ .Values.netmaker.database.host }}

            - name: SQL_PORT
              value: '{{ .Values.netmaker.database.port }}'

            - name: SQL_DB
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-db
                  key: Database
                  optional: false

            - name: SQL_USER
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-db
                  key: Username
                  optional: false

            - name: SQL_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ $fullName }}-netmaker-db
                  key: Password
                  optional: false


          ports:
            - containerPort: 8080
              name: http

            - containerPort: 50051
              name: grpc-agent


            {{ range untilStep (.Values.netmaker.server.wireguard.min|int) (.Values.netmaker.server.wireguard.max|int) 1 }}
            - name: 'udp-{{ . }}'
              containerPort: {{ . }}
              protocol: UDP

            - name: 'tcp-{{ . }}'
              containerPort: {{ . }}
              protocol: TCP
            {{ end }}

        - name: mq
          image: eclipse-mosquitto:2.0.11-openssl

          command: ['/wait.sh']

          volumeMounts:
            - mountPath: /mosquitto/data
              name: test-volume

            - mountPath: /mosquitto/config/mosquitto.conf
              name: config-vol
              subPath: mosquitto.conf

            - mountPath: /wait.sh
              name: config-vol
              subPath: wait.sh

          env:
            - name: NETMAKER_SERVER_HOST
              value: https://meshapi.ipaddr.network

          ports:
            - containerPort: 1883
              name: mqtt-main

        {{- with .Values.netmaker.server.sidecars }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      securityContext:
        seccompProfile:
          type: RuntimeDefault

{{- end }}
